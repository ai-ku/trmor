#!/usr/local/bin/xfst -f

clear

read lexc deriv.lexc
define deriv
source nflect.xfst
define nflect
read lexc vflect.lexc
define vflect
read lexc vzero.lexc
define vzero

push deriv
upper net
substitute defined nflect for "^Nflect"
substitute defined vflect for "^Vflect"
substitute defined vzero  for "^Vzero"
upper net
substitute label "+Past" for "+Past2"
substitute label "+Narr" for "+Narr2"
substitute label "+Imp" for "+Imp2"
substitute label "+WithoutHavingDoneSo" for "+WithoutHavingDoneSo2"
define model0

#read regex < deriv.regex
#define agree
#define model [ model0 & agree ];
define model model0;

push model
save stack deriv.fst
pop

load tfnowords.fst
define tf
read regex [ model - tf ];

#read regex ~$["+Equ"];
#read regex ~$["+Neg""+Aor" ? "^DB""+Adverb"["+While"|"+AsIf"]];
#intersect

print words > deriv.extra
print random-words 5000 > random.extra
clear

read regex [ "+Prop" "+Noun"* @-> 0 ];
load Milliyet.fst
compose net
lower net
read regex [["+Noun"|"+Verb"|"+Adj"] ?*];
intersect net
define test

read regex [ test - model ];
print words > deriv.missing
clear

! Extra:
! tf does not have AsIf after NegAor even though it does after PosAor:
! ^DB+Verb+Able+Neg+Aor+A3sg^DB+Adverb+AsIf

! Missing:
! 99 paths
! 55 x olasilik bug:
! olasilik: +Verb+Pos^DB+Noun+FeelLike+A3sg+Pnon+Nom^DB+Noun+Ness
! 18 x +Verb+Neg (degil)
! 6 x +Verb+Pos+Cond (ise)
! 5 x yapmacik bug:
! yap+Verb+Pos^DB+Noun+Inf2+A3sg+Pnon+Nom^DB+Noun+Dim+A3sg+Pnon+Nom
! 4 x imzalarlar bug: (root should be imzala)
! İmzalarlar	imza	+Noun+A3pl+Pnon+Nom^DB+Verb+Zero+Pres+A3pl
! PKK'lılarlar	Pkk	+Noun+Prop+A3sg+Pnon+Nom^DB+Adj+With^DB+Noun+Zero+A3pl+Pnon+Nom^DB+Verb+Zero+Pres+A3pl
! olanlarlar	ol	+Verb+Pos^DB+Adj+PresPart^DB+Noun+Zero+A3pl+Pnon+Nom^DB+Verb+Zero+Pres+A3pl
! temizlerler	temiz	+Adj^DB+Noun+Zero+A3pl+Pnon+Nom^DB+Verb+Zero+Pres+A3pl
! 2 x cikar bug: (root should be cikar)
! çik+Verb+Pos+Aor+Past+A3pl+Cond
! çik+Verb+Pos+Aor+Narr^DB+Adverb+While
! 2 x vericici bug:
! ver+Verb+Pos^DB+Noun+Agt+A3sg+Pnon+Nom^DB+Noun+Agt+A3sg+Pnon+Nom
! ver+Verb+Pos^DB+Adj+Agt^DB+Noun+Agt+A3sg+Pnon+Nom
! 2 x different A3pl position in Prop bug:
! ANLAŞMALAR'dır	anlaş	+Verb+Pos^DB+Noun+Inf2+Prop+A3pl+Pnon+Nom^DB+Verb+Zero+Pres+A3sg+Cop
! DGM'lerdir	Dgm	+Noun+Prop+A3pl+Pnon+Nom^DB+Verb+Zero+Pres+A3sg+Cop
! 1 x olmaksi bug:
! ol+Verb+Pos^DB+Noun+Inf1+A3sg+Pnon+Nom^DB+Adj+JustLike
! 1 x Yağışçık bug: (should be nominalized)
! yağ+Verb+Pos^DB+Noun+Inf3+A3sg+Pnon+Nom^DB+Noun+Dim+A3sg+Pnon+Nom
! 1 x terliksi bug: (root should be terlik)
! ter+Noun+A3sg+Pnon+Nom^DB+Noun+Ness+A3sg+Pnon+Nom^DB+Adj+JustLike
! 1 x iplikcik bug: (root should be iplik)
! ip+Noun+A3sg+Pnon+Nom^DB+Noun+Ness+A3sg+Pnon+Nom^DB+Noun+Dim+A3pl+Pnon+Dat
! 1 x tanidiklik bug: (root should be tanidik)
! tanı+Verb+Pos^DB+Noun+PastPart+A3sg+Pnon+Nom^DB+Noun+Ness+A3sg+Pnon+Nom

# define compat [
# 	"+Past2" -> "+Past",
# 	"+Narr2" -> "+Narr",
# 	"+Imp2"  -> "+Imp",
# 	"+WithoutHavingDoneSo2"	-> "+WithoutHavingDoneSo"
# ];
# read lexc deriv.mtac
# upper net
# define mtac0
# read regex [ mtac0 .o. compat ];
# lower net
# define mtac1

# !read regex < test/Milliyet.regex
# read regex < test/foo.short
# define mill1

# define noflect0 [ [\"^DB"]+ -> 0 || .#. ["+Noun"|"+Verb"] _ ["^DB"|.#.]];
# define noflect1 [ [\"^DB"]+ -> 0 || "^DB" ["+Noun"|"+Verb"] ? _ .#. ];
# define nva [["+Noun"|"+Verb"|"+Adj"] ?*];
# define db $["^DB"];
# define prop $["+Prop"];

# read regex [[mill1 & nva & db & ~prop] .o. noflect1 ];
# lower net
# define mill2

# define noroot [ \["+Noun"|"+Verb"|"+Adj"]* -> 0 || .#. _ ];
# read regex [ mtac1 .o. noroot ];
# lower net
# define mtac2
# read regex [[mtac2 & nva] .o. noflect1 ];
# lower net
# define mtac3

# read regex [ mill2 - mtac3 ];
# print words > deriv.missing

# # define filter ~$["NULL"];
# # read regex mtac .o. filter .o. compat;
# # lower net
# # define vupper
# # load tfeaturesulx.fst
# # push vupper
# # compose
# # upper net
# # define iupper
# # read regex [ vupper - iupper ];
# # print words > deriv.extra

! EXTRAs:

!+Verb^DB+Verb+Pass^DB+Verb+Able+Neg^DB+Noun+FutPart+A3sg+Pnon+Nom
! Accepted but not final state, Noun+FutPart cannot end with A3sg+Pnon?

!+Adj^DB+Verb+Acquire^DB+Verb+Able+Neg^DB+Noun+Inf1+A3sg+Pnon+Dat^DB+Verb+Zero+Cond+A3pl
! Inf1 cannot be followed by all the cases

!+Noun+A3sg+Pnon+Nom^DB+Adj+JustLike^DB+Noun+Ness+A3sg+Pnon+Nom^DB+Adj+Related^DB+Noun+Agt+A3sg+Pnon+Nom^DB+Adj+With^DB+Verb+Become+Pos^DB+Noun+Inf2+A3sg+Pnon+Nom^DB+Noun+Agt+A3sg+Pnon+Nom^DB+Adj+**JustLike^DB+Verb+Zero+Pres+A2pl
! Does not like the second JustLike

!+Noun+A3sg+Pnon+Nom^DB+Adj+Rel^DB+Noun+Zero+A3sg+P3sg+Gen^DB+Pron+Rel+A3sg+Pnon+Abl^DB+Verb+Zero^DB+Adverb+While^DB+Adj+Rel
! Does not let second Adj+Rel

!+Adj^DB+Verb+Become+Neg^DB+Noun+Inf1+A3sg+Pnon+Dat^DB+Verb+Zero+Narr+A2pl^DB+Adverb+AsIf
! Inf1+Dat

!+Noun+A3pl+Pnon+Nom^DB+Adj+InBetween^DB+Noun+Ness+A3sg+Pnon+Nom^DB+Adj+Related^DB+Noun+Agt+A3sg+Pnon+Nom^DB+Adj+With^DB+Noun+Agt+A3sg+Pnon+Nom^DB+Noun+Ness+A3sg+Pnon+Nom^DB+Adj+Without^DB+Noun+Agt+A3sg+Pnon+Nom^DB+Adj+Without^DB+Noun+Agt+A3sg+Pnon+Nom^DB+Noun+Ness+A3sg+Pnon+Nom^DB+Adj+With^DB+Adj+AsIf^DB+Noun+Zero+A3sg+Pnon+Nom^DB+Noun+Agt+A3pl+Pnon+Nom^DB+Verb+Zero+Cond+A3pl
! ?? Unmarked ^DB+Noun+Zero+A3sg+Pnon+Nom followed by another noun derivation ??

!+Verb+Pos^DB+Noun+FutPart+A3sg+Pnon+Abl^DB+Verb+Zero^DB+Adverb+While^DB+Adj+Rel
! Only lets +Nom after FutPart.  Milliyet has no FutPart+A3sg+Pnon

!+Noun+A3pl+Pnon+Nom^DB+Adj+InBetween^DB+Noun+Ness+A3sg+Pnon+Nom^DB+Adj+Related^DB+Noun+Ness+A3sg+Pnon+Nom^DB+Adj+Related^DB+Verb+Become^DB+Verb+Recip+Neg+Aor^DB+Adverb+While^DB+Adj+Rel
! ??

!+Verb+Pos^DB+Noun+FutPart+A3sg+Pnon+Gen^DB+Pron+Rel+A3pl+P3sg+Abl^DB+Verb+Zero^DB+Adverb+AsIf
! FutPart problem

!+Adj^DB+Adj+JustLike^DB+Noun+Ness+A3sg+Pnon+Nom^DB+Adj+With^DB+Verb+Become^DB+Verb+Reflex+Pos+Past+A1pl+Cond
! Reflex and Recip do not follow derived verbs



!+Adj^DB+Adj+AsIf^DB+Noun+Agt+A3sg+Pnon+Nom^DB+Adj+JustLike^DB+Noun+Ness+A3sg+Pnon+Nom^DB+Adj+Related^DB+Verb+Become+Neg^DB+Verb+Able+Neces+A1sg+Cop
! ?? something wrong after related+become

!+Noun+A3pl+Pnon+Nom^DB+Adj+InBetween^DB+Noun+Ness+A3sg+Pnon+Nom^DB+Adj+Related^DB+Verb+Become+Neg^DB+Adj+NarrPart^DB+Adj+AsIf
! ?? something wrong after related+become

!+Adj^DB+Adj+JustLike^DB+Noun+Ness+A3sg+Pnon+Nom^DB+Adj+Related^DB+Noun+Ness+A3sg+Pnon+Nom^DB+Adj+Related^DB+Verb+Become^DB+Verb+Able+Neg+Fut+A2pl+Cop
! ?? something wrong after related+become

!+Noun+A3sg+Pnon+Nom^DB+Noun+Agt+A3sg+Pnon+Nom^DB+Noun+Ness+A3sg+Pnon+Nom^DB+Adj+Related^DB+Noun+Agt+A3sg+Pnon+Nom^DB+Noun+Ness+A3sg+Pnon+Nom^DB+Adj+With^DB+Verb+Become+Neg^DB+Adj+AorPart^DB+Noun+Zero+A3sg+P1sg+Ins^DB+Verb+Zero+Narr+A3sg
! ??

!+Adj^DB+Adj+AsIf^DB+Noun+Ness+A3sg+Pnon+Nom^DB+Adj+Without^DB+Noun+Ness+A3sg+Pnon+Nom^DB+Adj+Without^DB+Adj+AsIf^DB+Adj+JustLike^DB+Noun+Ness+A3sg+Pnon+Nom^DB+Adj+Without^DB+Verb+Become^DB+Verb+Able+Neg^DB+Verb+Able^DB+Noun+Inf2+A3sg+Pnon+Nom^DB+Adj+With^DB+Adj+AsIf^DB+Noun+Ness+A3sg+Pnon+Nom^DB+Adj+With^DB+Noun+Ness+A3sg+Pnon+Nom^DB+Adj+Without^DB+Noun+Agt+A3sg+Pnon+Nom^DB+Adj+Without^DB+Verb+Acquire^DB+Verb+Pass+Pos^DB+Verb+Hastily^DB+Noun+FeelLike+A3sg+Pnon+Nom^DB+Noun+Ness+A3sg+Pnon+Nom^DB+Adj+With^DB+Adj+AsIf^DB+Noun+Agt+A3sg+Pnon+Nom^DB+Noun+Ness+A3sg+Pnon+Nom^DB+Adj+With^DB+Noun+Zero+A3sg+Pnon+Nom^DB+Adj+With
! ?? repeating with?

!+Verb^DB+Verb+Recip^DB+Verb+Caus+Pos^DB+Noun+FutPart+A3sg+Pnon+Loc^DB+Verb+Zero+Past+A2pl
! FutPart problem

!+Noun+A3sg+Pnon+Nom^DB+Noun+Ness+A3sg+Pnon+Nom^DB+Adj+With^DB+Adj+JustLike^DB+Noun+Ness+A3sg+Pnon+Nom^DB+Adj+Related^DB+Verb+Become+Neg+Prog2+A3sg+Cop
! ?? related+become

!+Verb^DB+Verb+Reflex+Neg^DB+Verb+Able^DB+Adj+NarrPart^DB+Verb+Zero^DB+Adverb+While^DB+Adj+Rel
! no narrpart+while in mill

!+Noun+A3sg+Pnon+Nom^DB+Noun+Agt+A3sg+Pnon+Nom^DB+Noun+Ness+A3sg+Pnon+Nom^DB+Adj+Without^DB+Verb+Acquire+Pos^DB+Adj+PresPart^DB+Verb+Zero+Pres+A3pl+Cop
! no a3pl after prespart+vzero

!+Verb+Neg^DB+Noun+Inf3+A3sg+Pnon+Nom^DB+Adj+Without^DB+Verb+Acquire^DB+Verb+Pass+Pos^DB+Adj+NarrPart^DB+Verb+Zero^DB+Adverb+While^DB+Adj+Rel
! no narrpart+while in mill
